F.context("staticController").run(function(){$(function(){var t={data:{},dataStatus:!1};t.getCityList=function(){return this.dataStatus&&this.data.city},t.getBranch=function(){return this.dataStatus&&this.data.shop},t.getData=function(){return this.dataStatus&&this.data},t.update=function(e,a,n){n=n||1;var i=F.context("deal_id")||1,o="undefined"==typeof e.page_size?4:e.page_size,c=e.cityCode||"",l=e.distId||"",d=F.context("ajax_url_shopchain")+"?dealId="+i+"&pageSize="+o+"&pn="+n+"&cityCode="+c+"&districtId="+l,r=F.context("specifyMerchantID");r&&(d+="&specifyMerchantID="+r);var u=F.context("previewCode");u&&(d+="&previewCode="+u);var s=[].slice.call(arguments,3);$.getJSON(d,function(e){if(0==e.errno){if(t.data=e.data,t.dataStatus=!0,"function"==typeof a){var n=[t.data].concat(s);a.apply(null,n)}}else t.dataStatus=!1,"function"==typeof a&&a(!1)})},require.async(["common:widget/map/map.js","common:widget/ui/pager/pager.js","common:widget/ui/dialog/dialog.js","common:widget/ui/template/template.js"],function(e,a,n,i){function o(){h.on("change",function(){t.update({cityCode:h.val()},l)}),v.on("change",function(){t.update({cityCode:h.val(),distId:v.val()},l,1,!1)}),$("#j-branch-list-content").on("click",".map-travel .map",function(t){var e={clkType:"map",lat:$(this).parent().data("latitude"),lng:$(this).parent().data("longitude")};c.call(this,t,e)}),$("#j-branch-list-content").on("click",".map-travel .travel",function(t){var e={clkType:"travel",lat:$(this).parent().data("latitude"),lng:$(this).parent().data("longitude")};c.call(this,t,e)}),$("#j-map-zoom").on("click",c)}function c(a,i){var o=t.getData(),c={shopName:o.name.substring(0,10)},l=p("tpl-map-dlg",c),d={width:"auto",height:"auto",title:"查看全图"};d.content=l;var r={onshow:function(a){function n(t){var e=t.target.getPosition();i(e.lat,e.lng)}function i(t,a,n){function i(){var e=$("#j-md-branch-view .shop-branch"),n="";return e.each(function(i,o){return a==$(o).attr("data-longitude")&&t==$(o).attr("data-latitude")?(e.hide(),$(o).show(),n=$(o).attr("data-value"),!1):void 0}),n}function o(){var n={title:r.name,width:290,height:"auto",panel:"j-search-result",enableAutoPan:!1,enableSendToPhone:!1,searchTypes:[BMAPLIB_TAB_TO_HERE,BMAPLIB_TAB_SEARCH,BMAPLIB_TAB_FROM_HERE]},i='<p style="line-height: 150%;">'+r.address+"<br/>"+r.tel+"</p>",o=new e.searchInfoWindow(s.getMapOrigin(),i,n);o.onClickClose(function(){$("#j-md-branch-view .shop-branch").show()}),s.addPin({baidu_latitude:t,baidu_longitude:a}),s.zoomTo(15).centerTo({baidu_latitude:t,baidu_longitude:a}),o.open({baidu_latitude:t,baidu_longitude:a}),m=o}function c(){s.zoomTo(15).centerTo({baidu_latitude:t,baidu_longitude:a})}for(var l=i(),d=l.split("&"),r={},u=0;u!=d.length;++u){var p=d[u].split("=");r[p[0]]=p[1]}n&&"map"==n?c():o()}function o(t,e,a){void 0===e&&(e=!0),0<t.count&&(e&&c(t.city),l(t.shop),d(t),a&&i(a.lat,a.lng,a.clkType))}function c(t){var e="",a="<option selected>全部城区</option>";for(var n in t){var i=t[n],o=g.replace("<%=value%>",i.city_code).replace("<%=name%>",i.city_name);if(i.district){o=o.replace("<%=selected%>","selected");var c=i.district;for(var l in c){var d=c[l],s=g.replace("<%=value%>",d.dist_id).replace("<%=name%>",d.dist_name);s=l==v.val()?s.replace("<%=selected%>","selected"):s.replace("<%=selected%>",""),a+=s}}o=o.replace("<%=selected%>",""),e+=o,r.html(e),u.html(a)}}function l(t){var e={shopList:t},a=f(e);$("#j-md-branch-view").html(a),$("#j-dlgShopCount").html("("+t.length+"家分店）")}function d(t){var e=t.shop;s.autoView(e),s.clearPin(),s.addPin(e,n),1==e.length&&s.zoomTo(15)}var r=$("#j-dialogFilterCity"),u=$("#j-dialogFilterDistrict"),s=new e("j-md-map-view"),m=null,f=p("tpl-dlg-shoplist");t.update({cityCode:h.val(),distId:v.val(),page_size:0},o,1,!0,a),r.on("change",function(){t.update({cityCode:r.val(),page_size:0},o)}),u.on("change",function(){t.update({cityCode:r.val(),distId:u.val(),page_size:0},o,1,!1)}),$("#j-md-branch-view").on("click",".shop-branch",function(){var t=$(this).attr("data-latitude"),e=$(this).attr("data-longitude");i(t,e)})}},u=$.extend(d,r),s=new n(u);return s.center(),s.show(i),!1}function l(t,e,a){void 0===e&&(e=!0),void 0===a&&(a=!0),0<t.count&&($("#ajax-shopchain").show(),e&&d(t.city),r(t.shop),a&&s(t.count),u(t))}function d(t){var e="",a="<option selected>全部城区</option>";for(var n in t){var i=t[n],o=g.replace("<%=value%>",i.city_code).replace("<%=name%>",i.city_name);if(i.district){o=o.replace("<%=selected%>","selected");var c=i.district;for(var l in c){var d=c[l],r=g.replace("<%=value%>",d.dist_id).replace("<%=name%>",d.dist_name).replace("<%=selected%>","");a+=r}}o=o.replace("<%=selected%>",""),e+=o,h.html(e),v.html(a)}}function r(t){var e={branch:t},a=p("tpl-branch-list",e);$("#j-branch-list-content").html(a).find("li").eq(0).removeClass("branch-close").addClass("branch-open")}function u(t){var a=new e("j-map-container"),n=t.shop;a.autoView(n),a.clearPin(),a.addPin(n),1==n.length&&a.zoomTo(15)}function s(e,n,i){n=n||4,i=i||1;var o={currentPage:i,totalPage:Math.ceil(e/n),viewSize:3,tplUrl:"##{pageNum}",tplLabelNormal:"#{pageNum}",tplLabelCurrent:"#{pageNum}",labelFirst:"",labelLast:"",showPrevWhenDisabled:!0,showNextWhenDisabled:!0};$("#j-branch-page").unbind("click");var c=new a("j-branch-page",o);c.on("pagechange",function(e){return t.update({cityCode:h.val(),distId:v.val()},l,e,!1,!1),!1})}var p=i.template,h=$("#j-af-1"),v=$("#j-af-2"),g='<option value="<%=value%>" <%=selected%> ><%=name%></option>';t.update({},l),o()})})});